<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>IT-Inventory | Computer List Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --border-subtle: #e5e7eb;
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
      --text: #111827;
      --text-soft: #6b7280;
      --radius-xl: 16px;
      --shadow-soft-sm: 0 8px 20px rgba(15,23,42,0.06);
      --small-font: 13px;
      --xsmall-font: 11px;
    }

    body {
      margin: 0;
      font-family: system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .page { max-width: 1200px; margin: 0 auto; padding: 20px; }

    .topbar {
      background: white;
      padding: 14px 18px;
      border-radius: 14px;
      box-shadow: var(--shadow-soft-sm);
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .brand { font-weight: 600; font-size: 16px; }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
    }

    input, select {
      padding: 6px 9px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: var(--small-font);
    }

    button {
      padding: 6px 12px;
      border-radius: 8px;
      border: none;
      background: var(--accent);
      color: white;
      cursor: pointer;
      font-size: var(--small-font);
    }

    button:hover { background: var(--accent-hover); }

    .table-wrap {
      background: white;
      border-radius: 12px;
      box-shadow: var(--shadow-soft-sm);
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--small-font);
    }

    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 8px 10px;
      text-align: left;
    }

    th {
      text-transform: uppercase;
      font-size: var(--xsmall-font);
      color: var(--text-soft);
      cursor: pointer;
    }

    tr:hover { background: #f1f5ff; }

    .status-using {
      color: #166534;
      background: #bbf7d0;
      border-radius: 999px;
      padding: 2px 8px;
    }

    .status-notuse {
      color: #1d4ed8;
      background: #dbeafe;
      border-radius: 999px;
      padding: 2px 8px;
    }

    .status-broken {
      color: #92400e;
      background: #fed7aa;
      border-radius: 999px;
      padding: 2px 8px;
    }
  </style>
</head>
<body>
<div class="page">
  <div class="topbar">
    <div class="brand">IT INVENTORY VIEWER</div>
    <div id="lastSync" style="font-size:12px;color:#6b7280;">Last update: â€”</div>
  </div>

  <div class="filters">
    <input type="text" id="searchInput" placeholder="Search asset / computer / hostname">
    <select id="statusFilter">
      <option value="">All status</option>
      <option value="using">Using</option>
      <option value="not use">Not use</option>
      <option value="broken">Broken</option>
    </select>
    <input type="text" id="deptFilter" placeholder="Department">
    <button id="reloadBtn">Reload CSV</button>
  </div>

  <div class="table-wrap">
    <table id="pcTable">
      <thead>
      <tr>
        <th data-sort="asset_id">Asset ID</th>
        <th data-sort="hostname">Hostname</th>
        <th data-sort="computer">Computer</th>
        <th data-sort="department">Department</th>
        <th data-sort="location">Location</th>
        <th data-sort="status">Status</th>
        <th data-sort="spec">Spec</th>
        <th data-sort="os">OS</th>
        <th data-sort="owner">Owner</th>
        <th data-sort="note">Note</th>
      </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
let computers = [];
let currentSortKey = "asset_id";
let currentSortAsc = true;

const tbody = document.querySelector("#pcTable tbody");
const searchInput = document.getElementById("searchInput");
const statusFilter = document.getElementById("statusFilter");
const deptFilter = document.getElementById("deptFilter");
const reloadBtn = document.getElementById("reloadBtn");
const lastSyncEl = document.getElementById("lastSync");

async function loadCSV() {
  try {
    const res = await fetch("inventory.csv?" + Date.now());
    if (!res.ok) throw new Error("CSV not found");
    const text = await res.text();
    computers = parseCSV(text);
    updateLastSync();
    renderTable();
  } catch (e) {
    console.error(e);
    lastSyncEl.textContent = "Error loading CSV";
  }
}

function parseCSV(csvText) {
  const lines = csvText.trim().split(/\r?\n/);
  const header = splitCSVLine(lines[0]);
  const data = [];
  for (let i = 1; i < lines.length; i++) {
    const cols = splitCSVLine(lines[i]);
    const row = {};
    header.forEach((key, idx) => row[key] = (cols[idx] || "").trim());
    data.push(row);
  }
  return data;
}

function splitCSVLine(line) {
  const result = [];
  let cur = "", inQ = false;
  for (let i = 0; i < line.length; i++) {
    const c = line[i];
    if (c === '"') {
      if (inQ && line[i + 1] === '"') { cur += '"'; i++; }
      else inQ = !inQ;
    } else if (c === ',' && !inQ) { result.push(cur); cur = ""; }
    else cur += c;
  }
  result.push(cur);
  return result;
}

function updateLastSync() {
  const latest = computers.reduce((max, c) =>
    c.last_update && c.last_update > max ? c.last_update : max, "0000-00-00");
  lastSyncEl.textContent = "Last update: " + (latest !== "0000-00-00" ? latest : "N/A");
}

function renderTable() {
  const keyword = searchInput.value.trim().toLowerCase();
  const fStatus = statusFilter.value;
  const fDept = deptFilter.value.trim();

  let data = [...computers];
  data = data.filter(c => {
    if (fStatus && c.status !== fStatus) return false;
    if (fDept && c.department !== fDept) return false;
    if (keyword) {
      const text = ((c.asset_id||"") + (c.hostname||"") + (c.computer||"") + (c.department||"")).toLowerCase();
      if (!text.includes(keyword)) return false;
    }
    return true;
  });

  data.sort((a,b)=>{
    const x=(a[currentSortKey]||"").toString();
    const y=(b[currentSortKey]||"").toString();
    if(x===y)return 0;
    return currentSortAsc?x.localeCompare(y):y.localeCompare(x);
  });

  tbody.innerHTML="";
  data.forEach(c=>{
    const stClass =
      c.status==="using"?"status-using":
      c.status==="not use"?"status-notuse":
      c.status==="broken"?"status-broken":"";
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${c.asset_id||""}</td>
      <td>${c.hostname||""}</td>
      <td>${c.computer||""}</td>
      <td>${c.department||""}</td>
      <td>${c.location||""}</td>
      <td><span class="${stClass}">${c.status||""}</span></td>
      <td>${c.spec||""}</td>
      <td>${c.os||""}</td>
      <td>${c.owner||""}</td>
      <td>${c.note||""}</td>
    `;
    tbody.appendChild(tr);
  });
}

searchInput.addEventListener("input", renderTable);
statusFilter.addEventListener("change", renderTable);
deptFilter.addEventListener("input", renderTable);
reloadBtn.addEventListener("click", loadCSV);
document.querySelectorAll("th[data-sort]").forEach(th=>{
  th.addEventListener("click",()=>{
    const key=th.getAttribute("data-sort");
    if(currentSortKey===key) currentSortAsc=!currentSortAsc;
    else {currentSortKey=key;currentSortAsc=true;}
    renderTable();
  });
});

loadCSV();
</script>
</body>
</html>
