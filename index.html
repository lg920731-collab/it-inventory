<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>IT-Inventory | 電腦設備狀態管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; margin: 20px; }
    h1 { margin-bottom: 6px; }
    p { margin: 4px 0 10px; font-size: 13px; color: #555; }
    .layout { display: grid; grid-template-columns: minmax(260px, 320px) 1fr; gap: 16px; align-items: flex-start; }
    .card {
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 6px;
      background: #fafafa;
    }
    .card h2 {
      margin: 0 0 6px;
      font-size: 16px;
    }
    label {
      display: block;
      font-size: 12px;
      margin: 4px 0 2px;
    }
    input, select, textarea, button {
      font-size: 13px;
      padding: 4px 6px;
      width: 100%;
      box-sizing: border-box;
    }
    textarea { resize: vertical; min-height: 40px; }
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
    }
    .btn-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }
    button {
      cursor: pointer;
      border-radius: 4px;
      border: 1px solid #ccc;
      background: #f0f0f0;
    }
    button.primary {
      background: #007bff;
      border-color: #007bff;
      color: #fff;
    }
    button.danger {
      background: #fff3f3;
      border-color: #e57373;
      color: #c62828;
    }

    .filters { margin-bottom: 4px; display: flex; flex-wrap: wrap; gap: 6px; }
    .filters input, .filters select { width: auto; }

    table { width: 100%; border-collapse: collapse; margin-top: 4px; }
    th, td { border: 1px solid #ddd; padding: 4px 6px; font-size: 12px; }
    th { cursor: pointer; white-space: nowrap; background: #f5f5f5; }
    tr:nth-child(even) { background: #ffffff; }
    .status-ok { color: #1b8a3c; font-weight: 600; }
    .status-repair { color: #c97b00; font-weight: 600; }
    .status-retired { color: #888; font-weight: 600; }
    .status-loan { color: #0066cc; font-weight: 600; }
    .note { font-size: 11px; color: #555; }
    .actions button {
      width: auto;
      padding: 2px 6px;
      font-size: 11px;
    }
  </style>
</head>
<body>

<h1>電腦設備狀態管理</h1>
<p>
  僅供公司內部使用 · 最後更新：<span id="lastSync"></span> ·
  本頁資料儲存於本機瀏覽器（測試用版本）
</p>

<div class="layout">
  <!-- 左側：新增 / 編輯表單 -->
  <div class="card">
    <h2 id="formTitle">新增 / 編輯電腦資料</h2>
    <form id="pcForm">
      <label>資產編號 (必填，作為唯一識別)
        <input type="text" id="asset_id" required>
      </label>

      <label>Hostname
        <input type="text" id="hostname">
      </label>

      <div class="row">
        <div>
          <label>使用者
            <input type="text" id="user">
          </label>
        </div>
        <div>
          <label>部門
            <input type="text" id="department" placeholder="如：行政 / 生產 / 品保 / 研發">
          </label>
        </div>
      </div>

      <div class="row">
        <div>
          <label>位置
            <input type="text" id="location" placeholder="如：辦公室A / 倉庫 / 機房">
          </label>
        </div>
        <div>
          <label>狀態
            <select id="status">
              <option value="正常">正常</option>
              <option value="維修中">維修中</option>
              <option value="報廢">報廢</option>
              <option value="借出中">借出中</option>
            </select>
          </label>
        </div>
      </div>

      <label>規格 (選填)
        <input type="text" id="spec" placeholder="如：i5 / 16GB / 512GB SSD">
      </label>

      <div class="row">
        <div>
          <label>作業系統
            <input type="text" id="os" placeholder="如：Windows 10 Pro">
          </label>
        </div>
        <div>
          <label>維護人員
            <input type="text" id="owner" placeholder="如：IT-Allen">
          </label>
        </div>
      </div>

      <label>備註
        <textarea id="note" placeholder="如：風扇有異音 / 送修中 / 預計報廢時間"></textarea>
      </label>

      <div class="btn-row">
        <button type="submit" class="primary">儲存（新增或更新）</button>
        <button type="button" onclick="clearForm()">清空表單</button>
      </div>
      <div class="btn-row">
        <button type="button" class="danger" onclick="resetToDefault()">重置為範例資料（本機）</button>
      </div>
    </form>
  </div>

  <!-- 右側：篩選 + 表格 -->
  <div>
    <div class="card">
      <h2>查詢 / 清單</h2>
      <div class="filters">
        <input type="text" id="searchInput" placeholder="搜尋 資產編號 / 使用者 / Hostname">
        <select id="statusFilter">
          <option value="">狀態：全部</option>
          <option value="正常">正常</option>
          <option value="維修中">維修中</option>
          <option value="報廢">報廢</option>
          <option value="借出中">借出中</option>
        </select>
        <input type="text" id="deptFilter" placeholder="部門：全部">
      </div>

      <table id="pcTable">
        <thead>
          <tr>
            <th data-sort="asset_id">資產編號</th>
            <th data-sort="hostname">Hostname</th>
            <th data-sort="user">使用者</th>
            <th data-sort="department">部門</th>
            <th data-sort="location">位置</th>
            <th data-sort="status">狀態</th>
            <th>備註</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
  const STORAGE_KEY = "it_inventory_data_v1";

  // 預設範例資料（可以改成你們實際資料）
  const defaultComputers = [
    {
      asset_id: "PC-001",
      hostname: "OFFICE-001",
      user: "王小明",
      department: "行政",
      location: "辦公室 A",
      type: "Desktop",
      spec: "i5 / 16GB / 512GB SSD",
      os: "Windows 10 Pro",
      status: "正常",
      last_update: "2025-11-01",
      owner: "IT-Allen",
      note: ""
    },
    {
      asset_id: "PC-012",
      hostname: "QA-LAB-01",
      user: "張品妤",
      department: "品保",
      location: "品保實驗室",
      type: "Desktop",
      spec: "i7 / 32GB / 1TB SSD",
      os: "Windows 11 Pro",
      status: "維修中",
      last_update: "2025-11-08",
      owner: "IT-Allen",
      note: "無法開機，送修中"
    },
    {
      asset_id: "NB-005",
      hostname: "SALES-NB-01",
      user: "李先生",
      department: "生產",
      location: "外出攜帶",
      type: "Laptop",
      spec: "Ryzen 5 / 16GB / 512GB",
      os: "Windows 11 Pro",
      status: "借出中",
      last_update: "2025-11-03",
      owner: "IT-Allen",
      note: "預計 11/15 歸還"
    },
    {
      asset_id: "PC-020",
      hostname: "OLD-SERVER-01",
      user: "-",
      department: "研發",
      location: "機房",
      type: "Desktop",
      spec: "古老機種",
      os: "Windows 7",
      status: "報廢",
      last_update: "2025-10-20",
      owner: "IT-Allen",
      note: "僅保留硬碟待銷毀"
    }
  ];

  let computers = [];
  let currentSortKey = "asset_id";
  let currentSortAsc = true;

  const lastSyncEl = document.getElementById("lastSync");
  const tbody = document.querySelector("#pcTable tbody");
  const searchInput = document.getElementById("searchInput");
  const statusFilter = document.getElementById("statusFilter");
  const deptFilter = document.getElementById("deptFilter");
  const formTitle = document.getElementById("formTitle");

  const form = document.getElementById("pcForm");
  const f_asset_id = document.getElementById("asset_id");
  const f_hostname = document.getElementById("hostname");
  const f_user = document.getElementById("user");
  const f_department = document.getElementById("department");
  const f_location = document.getElementById("location");
  const f_status = document.getElementById("status");
  const f_spec = document.getElementById("spec");
  const f_os = document.getElementById("os");
  const f_owner = document.getElementById("owner");
  const f_note = document.getElementById("note");

  function loadData() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        if (Array.isArray(parsed)) return parsed;
      } catch (e) {
        console.warn("localStorage 資料解析失敗，使用預設資料");
      }
    }
    return [...defaultComputers];
  }

  function saveData() {
    // 自動寫入 last_update 為今天
    const today = new Date().toISOString().slice(0, 10);
    computers = computers.map(c => ({
      ...c,
      last_update: c.last_update || today
    }));
    localStorage.setItem(STORAGE_KEY, JSON.stringify(computers));
    updateLastSync();
    renderTable();
  }

  function updateLastSync() {
    if (!computers.length) {
      lastSyncEl.textContent = "無資料";
      return;
    }
    const latest = computers.reduce(
      (max, c) => (c.last_update && c.last_update > max ? c.last_update : max),
      "0000-00-00"
    );
    lastSyncEl.textContent = latest || "未設定";
  }

  function renderTable() {
    const keyword = searchInput.value.trim().toLowerCase();
    const fStatus = statusFilter.value;
    const fDept = deptFilter.value.trim();

    let data = [...computers];

    // 篩選
    data = data.filter(c => {
      if (fStatus && c.status !== fStatus) return false;
      if (fDept && c.department !== fDept) return false;
      if (keyword) {
        const text = (
          (c.asset_id || "") +
          (c.hostname || "") +
          (c.user || "") +
          (c.department || "")
        ).toLowerCase();
        if (!text.includes(keyword)) return false;
      }
      return true;
    });

    // 排序
    data.sort((a, b) => {
      const x = (a[currentSortKey] || "").toString();
      const y = (b[currentSortKey] || "").toString();
      if (x === y) return 0;
      return currentSortAsc
        ? x.localeCompare(y, "zh-Hant")
        : y.localeCompare(x, "zh-Hant");
    });

    // 畫表格
    tbody.innerHTML = "";
    data.forEach(c => {
      const tr = document.createElement("tr");

      const statusClass =
        c.status === "正常" ? "status-ok" :
        c.status === "維修中" ? "status-repair" :
        c.status === "報廢" ? "status-retired" :
        c.status === "借出中" ? "status-loan" : "";

      tr.innerHTML = `
        <td>${c.asset_id || ""}</td>
        <td>${c.hostname || ""}</td>
        <td>${c.user || ""}</td>
        <td>${c.department || ""}</td>
        <td>${c.location || ""}</td>
        <td class="${statusClass}">${c.status || ""}</td>
        <td class="note">${c.note || ""}</td>
        <td class="actions">
          <button type="button" onclick="editComputer('${c.asset_id || ""}')">編輯</button>
          <button type="button" onclick="deleteComputer('${c.asset_id || ""}')">刪除</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  // 點欄位標題排序
  document.querySelectorAll("th[data-sort]").forEach(th => {
    th.addEventListener("click", () => {
      const key = th.getAttribute("data-sort");
      if (currentSortKey === key) {
        currentSortAsc = !currentSortAsc;
      } else {
        currentSortKey = key;
        currentSortAsc = true;
      }
      renderTable();
    });
  });

  // 表單送出：新增或更新
  form.addEventListener("submit", function (e) {
    e.preventDefault();

    const asset_id = f_asset_id.value.trim();
    if (!asset_id) {
      alert("請填寫資產編號（必填，且不可重複）");
      return;
    }

    const existingIndex = computers.findIndex(c => c.asset_id === asset_id);

    const today = new Date().toISOString().slice(0, 10);
    const newData = {
      asset_id,
      hostname: f_hostname.value.trim(),
      user: f_user.value.trim(),
      department: f_department.value.trim(),
      location: f_location.value.trim(),
      status: f_status.value,
      spec: f_spec.value.trim(),
      os: f_os.value.trim(),
      owner: f_owner.value.trim(),
      note: f_note.value.trim(),
      last_update: today
    };

    if (existingIndex >= 0) {
      computers[existingIndex] = newData;
    } else {
      computers.push(newData);
    }

    saveData();
    clearForm();
  });

  // 清空表單
  function clearForm() {
    form.reset();
    f_status.value = "正常";
    formTitle.textContent = "新增 / 編輯電腦資料";
  }

  // 編輯：把資料帶回左邊表單
  function editComputer(asset_id) {
    const c = computers.find(x => x.asset_id === asset_id);
    if (!c) return;
    f_asset_id.value = c.asset_id || "";
    f_hostname.value = c.hostname || "";
    f_user.value = c.user || "";
    f_department.value = c.department || "";
    f_location.value = c.location || "";
    f_status.value = c.status || "正常";
    f_spec.value = c.spec || "";
    f_os.value = c.os || "";
    f_owner.value = c.owner || "";
    f_note.value = c.note || "";
    formTitle.textContent = `編輯：${c.asset_id}`;
    f_asset_id.focus();
  }

  // 刪除
  function deleteComputer(asset_id) {
    if (!asset_id) return;
    if (!confirm(`確定要刪除資產編號 ${asset_id} 嗎？`)) return;
    computers = computers.filter(c => c.asset_id !== asset_id);
    saveData();
    if (f_asset_id.value === asset_id) clearForm();
  }

  // 重置為預設資料（只影響本機）
  function resetToDefault() {
    if (!confirm("此動作只影響本機瀏覽器，將清除目前資料並還原為範例，確定？")) return;
    localStorage.removeItem(STORAGE_KEY);
    computers = [...defaultComputers];
    updateLastSync();
    renderTable();
    clearForm();
  }

  // 暴露給 HTML onclick 用
  window.editComputer = editComputer;
  window.deleteComputer = deleteComputer;
  window.resetToDefault = resetToDefault;
  window.clearForm = clearForm;

  // 初始化
  (function init() {
    computers = loadData();
    updateLastSync();
    renderTable();
  })();
</script>

</body>
</html>
